---
title: "Data Project NHANES 2025"
author: Yanhang Qiu
output: html_document
---

1.  Familiarize yourself with the NHANES study design and the variables in the dataset by reading the sections "About the NHANES study" and "The data set" of this document. Use the information provided to answer the following questions:

a)  What are important characteristics of the NHANES study (study design, target population, study objectives, study period, ...)?

**Answer to 1a:**

-   Study design: cross-sectional study - target population: recident non-institutionalized US population (adults and childern)

-   Study objectives: to determine the prevalence of major diseases and risk factors, to design health promotion campaigns, and to establish national reference values (e.g. for height, weight, blood pressure).

-   Study period: This is an ongoing study with data released in bianual cycles.

-   Sampling methods: A four-stage stratified probability cluster sample.

b)  What general categories (such as "demographics", "lab results") can the variables in the dataset be sorted into?

    **Answer to 1b:** The variables in the dataset can be categorized into five main groups: demographic data, examination data, laboratory data, dietary data, and questionnaire data.

```{r 1b, message=FALSE, warning=FALSE}

data <- read.csv2("../data/NHANES1.csv",row.names = 1)
data_raw <- data

categories <- list(
  demographic_data = c("seqn","age","educ","martlst","male","ethnic","increl","age.cat","age_bin"),
  examination_data  = c("weight","height","bmi","rr_sys","rr_dia","bmi_cat"),
  dietary_data = c("rdyfood_prvmo","frzfood_prvmo","milk_month"),
  laboratory_data = c("cd","pb","hg","hdl","logHdl","hivpos")
)

categories$questionnaire_data <- setdiff(names(data), unlist(categories))
cat_df <- stack(categories)
names(cat_df) <- c("variable", "category")

summary_table <- data.frame(
  variable = names(data),                 
  type = sapply(data, class),
  missing = colSums(is.na(data)),
  stringsAsFactors = FALSE
)

summary_table <- merge(summary_table, cat_df, by = "variable", all.x = TRUE)

summary_table [1:5,]



```

2.  Using the subsample you have chosen, describe the US population with regards to

    a)  Demographic characteristics. How can the strange age distribution be explained? To deal with this problem, recode the age variable into the following categories:18-34, 35-49, 50-64, 65-79, 80 or higher.



```{r 2a, message=FALSE, warning=FALSE}
library(ggplot2) 

plot_age <- ggplot(data, aes(x = age)) +
  geom_histogram(fill = "pink", color = "white",bins = 30) +
  labs(title = "age",x = "Age",y = "Count") +
  theme_minimal()
```

```{r 2a, message=FALSE, warning=FALSE}
library(dplyr)
data <- data %>%
  mutate(
    age_group = case_when(
      age < 18 ~ "0-17",
      age >= 18 & age < 35 ~ "18-34",
      age >= 35 & age < 50 ~ "35-49",
      age >= 50 & age < 65 ~ "50-64",
      age >= 65 & age < 80 ~ "65-79",
      age >= 80 ~ "80+"
    )
  )
```

```{r 2a, message=FALSE, warning=FALSE}
plot_age_cate <-ggplot(data, aes(x=factor(age_group))) + geom_bar(fill = "pink") + 
  labs(title = "age_group", x = "Age Group", y = "Count") +
  theme_minimal()


library(patchwork)
(plot_age | plot_age_cate) 
```
 **Answer to 2a:** The age distribution in the sample shows limited representativeness of the U.S. population, displaying an approximately uniform count across all age intervals. Despite the complex four-stage sampling design, potential biases may still arise — for example, due to substantial differences in age composition across districts, or because older participants tend to be less willing to respond compared to younger individuals. By grouping participants into age categories, we can reweight each group so that the overall age distribution in the sample better reflects that of the U.S. population.


b)  When asked about Marital status, some of the participants refused to answer while some didn't know which category they belonged. Hence they were coded differently. Take that into account and recode the variable martlst.

```{r 2b, message=FALSE, warning=FALSE}

data <- data %>%
  mutate(
    martlst_clean = na_if(martlst, 77),
    martlst_clean = na_if(martlst_clean, 99)
  )

table(data$martlst)
table(data$martlst_clean, useNA = "ifany")

```

 **Answer to 2b:** Before recoding martlst the requency of 77 and 99 are 267 and 1 respectively.After recoding the missing value into NA, there are 268 NAs in total.



c)  Self-rated health. Looking at the results of your descriptive analysis, what do you have to consider when interpreting the results?

```{r 2c1, message=FALSE, warning=FALSE}

library(ggplot2)
library(scales)

p1 <- ggplot(data, aes(x = factor(srhgnrl), y = after_stat(prop), group = 1)) +
  geom_bar(aes(y = after_stat(prop)), fill = "lightblue") +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "srhgnrl")

p1

```

 **Answer to 2c:** According to the bar chart, most participants reported their general health as “good,” “very good,” or “excellent,” suggesting an overall positive perception of health in this sample. However, a considerable proportion of responses for the self-rated health item was missing (over 10%). Such missingness may be systematic rather than random, potentially resulting from factors such as privacy concerns, social desirability bias, or poor physical and mental health conditions that prevent individuals from completing self-rating questions.

To examine this potential bias, we hypothesized that the missingness pattern differs across age, gender, income and used chi-square analyses to test whether missingness in the self-rated health was systematically associated with these characteristics.

```{r 2c2, message=FALSE, warning=FALSE}

library(dplyr)
library(broom)

self_health <- data %>%
  select(age_group, male, increl, srhgnrl) %>%
  mutate(
    missing_self = as.integer(is.na(srhgnrl))
  )

by_gender <- self_health %>%
  group_by(male) %>%
  summarise(n = n(),
            n_missing = sum(missing_self),
            pct_missing = round(100 * n_missing / n, 1),
            .groups = "drop")

by_age <- self_health %>%
  group_by(age_group) %>%
  summarise(n = n(),
            n_missing = sum(missing_self),
            pct_missing = round(100 * n_missing / n, 1),
            .groups = "drop")

by_increl <- self_health %>%
  group_by(increl) %>%
  summarise(n = n(),
            n_missing = sum(missing_self),
            pct_missing = round(100 * n_missing / n, 1),
            .groups = "drop")

by_gender; by_age; by_increl


chisq_gender <- chisq.test(table(self_health$male,       self_health$missing_self))
chisq_age    <- chisq.test(table(self_health$age_group,  self_health$missing_self))
chisq_increl <- self_health %>%
  filter(!is.na(increl)) %>%
  with(chisq.test(table(increl, missing_self)))

chisq_gender
chisq_age
chisq_increl


```

 **Answer to 2c (continue) :** Chi-square tests were conducted to examine whether missingness in the self-rated health variable was randomly distributed across demographic and socioeconomic characteristics. The results indicate that missing self-rated health information was significantly associated with sex (χ² = 13.52, p < 0.001), age group (χ² = 40.49, p < 0.001), and family income relative to the poverty line (χ² = 23.96, p < 0.001).

These findings suggest that missingness in the self-rated health variable is systematic rather than random. In particular, participants who are male, older, or have lower family income were more likely to have missing responses. As a result, complete-case analyses may disproportionately exclude individuals with potentially poorer health and socioeconomic disadvantage, leading to an overestimation of overall health status in the analytic sample. Therefore, the missing data mechanism is unlikely to be Missing Completely at Random (MCAR), and appropriate methods such as multiple imputation or inverse probability weighting should be considered to reduce selection bias.


3.  Diabetes and ethnicity

    a)  How is the diabetes status distributed in your data set? Summarize the 2 diabetes groups in a single group and recode the variable for diabetes status into two groups: non-diabetes and diabetes. Give an interval estimate for diabetes in your data set.

```{r 3a, message=FALSE, warning=FALSE}

library(dplyr)

table(data$diab_lft, useNA = "ifany")
table(data$diab_lft)
barplot(table(data$diab_lft))

data <- data %>%
  mutate(
    diabetes_status = case_when(
      diab_lft == 1 ~ "non_diabetes",
      diab_lft == 2 | diab_lft == 3 ~ "diabetes",
      TRUE ~ NA_character_
    )
  )

table(data$diabetes_status, useNA = "ifany")
barplot( table(data$diabetes_status))

library(broom)

x <- sum(data$diabetes_status == "diabetes", na.rm = TRUE)
n <- sum(!is.na(data$diabetes_status))

CI_CP<- binom.test(x, n, conf.level = 0.95) # method 1: Clopper-Pearson
tidy(CI_CP)

install.packages("binom")
library(binom)

binom.confint(x,n, conf.level = 0.95, methods = "wilson") # method 2: Wilson



```

 **Answer to 3a :** The vast majority of participants fall into category 1, indicating that most individuals are non-diabetic. A smaller fraction (category 3) are diabetic, and very few are prediabetic (category 2). 

Based on our data, the estimated proportion of individuals with diabetes is about 12.8%. The CI are consistent using two methods : Wilson and Clopper-Pearson methods. The 95% confidence interval ranges approximately from 11.9% to 13.8 in both methods, meaning that if you repeated this sampling many times, 95% of such intervals would contain the true population proportion of diabetes. 

```         
b) Work with the recoded variable. Use an appropriate statistical test to test the relation between diabetes status and ethnicity. Inteprete the results of the test. 
```

```{r}


data$diabetes_status <- factor(data$diabetes_status)
data$ethnic <- factor(data$ethnic)

tab <- table(data$diabetes_status, data$ethnic)
tab


chisq.test(tab)

```

 **Answer to 3b :**As diabetes_status is binomial variable and ethnicity is a nominal variable, we use chi-square test to exam their relationship. Results show that there is significant association (p = 7.296e-08 <0.05) between diabetes status and ethinicty.
 
 

4.  Weekly working hours and self-evaluated health status

    a)  The variable `hrsworked_prvwk` codes the number of weekly working hours. 77777 or 99999 are missing values. Recode these missing values with a proper value, e.g. NA.

```{r message=FALSE, warning=FALSE}

data <- data %>%
  mutate(
    hrsworked_prvwk_clean = na_if(hrsworked_prvwk, 77777),
    hrsworked_prvwk_clean = na_if(hrsworked_prvwk_clean, 99999)
  )

table(data$hrsworked_prvwk,useNA = "ifany")
```
  **Answer to 4a :** In variabe `hrsworked_prvwk` there are 2 77777, 1 99999 and 2474 NA values. After recoding 77777 and 99999 to NA, there are 2477 NA in total. 
 

 
 b) Recode the variable `hrsworked_prvwk` into categories [,40), [40,) weekly working hours. Number or name the categories properly. (Hint: Set the new variable as a factor variable, if necessary)
 
 
```{r 4b message=FALSE, warning=FALSE}
library(dplyr)

table(data$hrsworked_prvwk_clean)

data <- data %>%
  mutate(
    hrsworked_prvwk_cat = case_when(
      is.na(hrsworked_prvwk_clean) ~ NA_character_,   # 把 NA 明确保留
      hrsworked_prvwk_clean < 40 ~ "< 40",
      hrsworked_prvwk_clean >= 40 ~ ">= 40"
    )
  )

table(data$hrsworked_prvwk_cat,useNA = "ifany")
```
 **Answer to 4b :**  After categorizing the variable, there are 846 people working less than 40 hours previous week, 1677 people working more than 40 hours previous week, and still, there are 2477 missing values. 



   c) Plot weekly working hours against self-evaluated health status using mosaic plot. Looking at the plot, what would you tell about the relation between these two variables.
   
  **Answer to 4b :** According to the mosaic plot, the distribution of self-rated health levels is similar across the two working-hour groups (< 40 vs. ≥ 40 hours). 
  
```{r 4c message=FALSE, warning=FALSE }

mosaicplot(table(data$srhgnrl, data$hrsworked_prvwk_cat), color = TRUE, main = "Mosaic Plot") # 更鲜明的红蓝色差异

```
   
   d) Use an appropriate statistical test to test for the statistical significance of this relation. Inteprete the results of the test.
   
```{r 4d message=FALSE, warning=FALSE }

d1 <- subset(data, !is.na(srhgnrl) & !is.na(hrsworked_prvwk_cat))
tab <- table(d1$srhgnrl, d1$hrsworked_prvwk_cat)
tab
chisq.test(tab)

d2 <- subset(data, !is.na(srhgnrl) & !is.na(hrsworked_prvwk_clean))
cor.test(d2$hrsworked_prvwk_clean, d2$srhgnrl,
         method = "spearman", exact = FALSE)


```
   
**Answer to 4b :**  The chi-square test was used to assess whether self-rated health status differs between participants working fewer than 40 hours per week and those working 40 hours or more. The test indicated no statistically significant association between weekly working hours (< 40 vs. ≥ 40 hours) and self-rated health (χ² ≈ 3.24, df = 4, p ≈ 0.52). Therefore, based on this dataset, weekly working hours (< 40 vs. ≥ 40 hours) do not appear to be related to how individuals evaluate their overall health.

Although the mosaic plot analysis required categorizing weekly working hours into two groups (<40 vs. ≥40 hours), this grouping may reduce variability and potentially mask underlying trends. To address this concern, we additionally examined the relationship while preserving the continuous form of weekly working hours. The Spearman rank correlation between weekly working hours and self-rated health was very small and not statistically significant (ρ = -0.04, p = 0.08). This also indicates that there is no clear monotonic relationship between the number of hours worked per week and participants’ self-evaluated health status in this sample.



5. Blood mercury level (umol/L) and gender

    a) Describe and plot the distribution of blood mercury level in men and women.
   
```{r 5a message=FALSE, warning=FALSE  }


hg_by_male <- data %>%
  group_by(male) %>%
  summarise(
    mean_hg = mean(hg, na.rm = TRUE),
    sd_hg   = sd(hg, na.rm = TRUE),
    min_hg  = min(hg, na.rm = TRUE),
    max_hg  = max(hg, na.rm = TRUE),
    p25_hg  = quantile(hg, 0.25, na.rm = TRUE),
    p59_hg = median(hg, na.rm = TRUE),
    p75_hg  = quantile(hg, 0.75, na.rm = TRUE),
    p95_hg  = quantile(hg, 0.95, na.rm = TRUE),
    n       = sum(!is.na(hg)),
    n_missing = sum(is.na(hg)),
  )

hg_by_male %>%
  mutate(across(where(is.numeric), ~ round(.x, 2)))

```
**Answer to 5b :** Through descriptive analysis, we observed that blood mercury levels among participants varied widely, ranging from approximately 0.5 to more than 200 µg/L. Notably, about 25% of individuals had levels above 30 µg/L, indicating a substantial subgroup with elevated exposure. Because different mercury concentration ranges correspond to distinct levels of health risk, we categorized the blood mercury variable into clinically meaningful risk groups based on internationally recognized guidelines from WHO, CDC, ATSDR, and EPA. This categorization provides a clearer interpretation of exposure severity and allows for more informative and interpretable visualizations.
  
```{r 5a message=FALSE, warning=FALSE  }
library(dplyr)

data <- data %>%
  mutate(
    hg_risk_group = case_when(
      hg < 5                        ~ "<5 µg/L (Background level)",
      hg >= 5  & hg < 15            ~ "5–15 µg/L (Mild elevation)",
      hg >= 15 & hg < 50            ~ "15–50 µg/L (Moderate elevation)",
      hg >= 50 & hg < 100           ~ "50–100 µg/L (High exposure)",
      hg >= 100                     ~ "≥100 µg/L (Potential toxicity)",
      TRUE                          ~ NA_character_
    ),
    hg_risk_group = factor(
      hg_risk_group,
      levels = c(
        "<5 µg/L (Background level)",
        "5–15 µg/L (Mild elevation)",
        "15–50 µg/L (Moderate elevation)",
        "50–100 µg/L (High exposure)",
        "≥100 µg/L (Potential toxicity)"
      ),
      ordered = TRUE
    )
  )

library(dplyr)

n_total <- nrow(data)
n_valid <- sum(!is.na(data$hg_risk_group))

risk_summary <- data %>%
  mutate(group = ifelse(is.na(hg_risk_group), "Missing", as.character(hg_risk_group))) %>%
  count(group, name = "n") %>%
  mutate(
    pct_including_missing = round(n / n_total * 100, 1),   
    pct_excluding_missing = round(ifelse(group == "Missing", NA, n / n_valid * 100), 1) 
  ) %>%

  mutate(group = factor(group,
                        levels = c("<5 µg/L (Background level)",
                                   "5–15 µg/L (Mild elevation)",
                                   "15–50 µg/L (Moderate elevation)",
                                   "50–100 µg/L (High exposure)",
                                   "≥100 µg/L (Potential toxicity)",
                                   "Missing"),
                        ordered = TRUE)) %>%
  arrange(group)

risk_summary


library(ggplot2)
ggplot(
  data %>% filter(!is.na(hg_risk_group)),
  aes(x = hg_risk_group)
) +
  geom_bar(fill = "grey20") +
  labs(
    x = "Blood Mercury Level Category",
    y = "Number of Participants",
    title = "Distribution of Blood Mercury Risk Levels (Missing Excluded)"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 25, hjust = 1))
```

**Answer to 5b :** The bar chart illustrates the distribution of blood mercury levels after excluding missing observations. The majority of participants (approximately 55.8%) fall within the background exposure range (<5 µg/L). A small proportion (about 1.7%) exhibit blood mercury concentrations exceeding 50 µg/L, placing them in high-exposure or potentially toxic risk categories. The remaining participants show mild to moderate elevation.


    b) Use both parametric and non-parametric statistical tests to test for the statistical significance the relation between blood mercury level and gender. Inteprete the results of the tests.
    
    **Answer to 5b :** 
    
    
    
    
    
    
    
    
    
    
    
    
    
    
  
   6. BMI and HDL 

    a) How strong is the relationship between BMI and HDL (the "good" cholesterol)? Is it significant? 	How much of the variation in HDL can be explained (in a statistical sense) by variation in BMI?

    b) Does the relationship between HDL and BMI change when you adjust for age (categorized)? Interpret the coefficients of the resulting model (when you mean-center BMI before fitting the model, you can also interpret the intercept). Would you say that BMI has a clinically	relevant impact on HDL, according to your model? 

    c) Try to find a better model to predict HDL by including more covariates. Select a number of candidate covariates which in your opinion may be related to HDL, and then choose a model selection strategy and a criterion/test for comparing models. Describe the model with the best fit according to your search, and interpret the	model coefficients.
	
7. Cancer

    a) Estimate the lifetime prevalence of cancer. Can you also give an interval estimate?

    b) What are the prevalence estimates in those who were exposed to pollutants at work for a longer time period, and in those who weren’t? Is there a significant difference in prevalence between these two subgroups?
  
    c) Adjust for age in the relationship between lifetime diagnosis of cancer and exposure to pollutants, using the categorized age variable (Note: No information on pollutant exposure was collected from participants aged 80+, so these cannot be included in the analysis). Does the adjustment for age change the picture? Interpret the model coefficients including the intercept.

    d) Try to find a good model of cancer diagnosis, describe, and interpret it, as you did for HDL.
